<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Weather Dashboard</title>
    <!-- set up responsive design -->
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- Bootstrap call  -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
        integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <!-- local style sheet -->
    <link rel="stylesheet" href="style.css">
    <!-- jQuery & AJAX -->
    <script src="https://code.jquery.com/jquery.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.0.0/js/bootstrap.bundle.min.js"></script>
    <!-- BootStrap's jQuery calls -->
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
        integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
        integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
        crossorigin="anonymous"></script>
</head>

<body class="container-sm">
    <header class="row">
        <h1 class="col cen">Weather Dashboard</h1>
    </header>

    <body>
        <!-- create aside -->
        <div class="row">
            <div class="sidebar pull-left col-2">
                <!-- Display search box, submit icon, for user input form to get city -->
                <form id="city-form">
                    <!-- Label for Text Box -->
                    <label for="city-input">Search for a City</label>

                    <!-- Text Input Box -->
                    <input type="text" id="city-input">

                    <!-- Submit Button -->
                    <input id="submitted-city" type="submit" value="Submit">
                    <!--this should be a search icon -->
                </form>
            </div>

            <!-- HtmL framework for data from APIs -->
            <div id="weather" class="pull-right col-10">
                <div class="city"></div>
                <div class="temp"></div>
                <div class="humidity"></div>
                <div class="wind"></div>
                <div class="uvindex"></div>
                <br /><br /><br />
                <hr />
                <div id="forecast" class="row"></div>
            </div>
        </div>
        <script type="text/javascript">

            $(document).ready(function () {

                // event listener on the Submit button
                $("#submitted-city").on("click", function (event) {
                    // Preventing the button from trying to submit the form
                    event.preventDefault();

                    //initialize the page
                    $(".city").empty();
                    $("#forecast").empty();

                    // Storing the submitted city name
                    var subCity = $("#city-input").val().trim();
                    console.log(subCity);
                    // OpenWeather API key
                    var APIKey = "7321de3bce923134cdfb94c3f0188e62";

                    // OpenWeather query for current weather with user imput and api key
                    var queryURL = "https://api.openweathermap.org/data/2.5/weather?q=" + subCity + "&units=imperial&appid=" + APIKey

                    //declare and define date variables
                    var longDate = new Date();
                    console.log(longDate);
                    var dd = longDate.getDate();
                    var mm = longDate.getMonth() + 1;
                    var yyyy = longDate.getFullYear();
                    console.log(mm, dd, yyyy);

                    //call functions for current weather and the five-day forecast
                    displaySidebar(subCity);
                    getCurrentWeather(queryURL, dd, mm, yyyy);
                    getForecast(subCity, APIKey, dd, mm, yyyy);
                });

                //gets and renders current weather
                function getCurrentWeather(queryURL, dd, mm, yyyy) {
                    if (dd < 10) {
                        dd = '0' + dd;
                    }
                    var today = mm + '/' + dd + '/' + yyyy;


                    // Call to OpenWeather server for current weather data, render city, today's date, weather icon
                    $.ajax({
                        url: queryURL,
                        method: "GET"
                    })
                        // We store all of the retrieved data inside of an object called "response"
                        .then(function (response) {

                            // Log the resulting object for reference
                            console.log(response);
                            var lat = response.coord.lat;
                            var lon = response.coord.lon;

                            //Retrieve the weather icon
                            var icon = ("<img src='http://openweathermap.org/img/w/" + response.weather[0].icon + ".png'>");

                            //Render City, date, and Weather Icon
                            $(".city").append("<h3>" + response.name + " " + today + " " + icon + "</h3>");

                            // Render Temp, Wind Speed, Humidity and UV content to HTML
                            $(".temp").text("Temperature: " + response.main.temp + " degrees");   //add degress symbol
                            $(".wind").text("Wind Speed: " + response.wind.speed + " mph");
                            $(".humidity").text("Humidity: " + response.main.humidity + "%");

                            //call the UV index functiongit 
                            getCurrentUV(lat, lon);
                        });
                };

                function getCurrentUV(lat, lon) {
                    console.log(lat, lon);
                    // Call to OpenWeather server for current weather data, render city, today's date, weather icon
                    $.ajax({
                        url: "http://api.openweathermap.org/data/2.5/uvi?appid=7321de3bce923134cdfb94c3f0188e62&lat=" + lat + "&lon=" + lon,
                        method: "GET"
                    })
                        // We store all of the retrieved data inside of an object called "response"
                        .then(function (response) {

                            // Log the resulting object for reference
                            console.log(response);

                            // Transfer content to HTML
                            $(".uvindex").text("UV Index:  " + response.value);
                        });
                };

                // gets and displays the five-day forecast
                function getForecast(subCity, APIKey, dd, mm, yyyy) {
                    var forecastUrl = "https://api.openweathermap.org/data/2.5/forecast";

                    $.ajax({
                        url: forecastUrl, //API Call
                        type: "GET",
                        data: {
                            q: subCity,
                            appid: APIKey,
                            units: "imperial",
                        },
                        success: function (response) {
                            for (var i = 0; i < 5; i++) {
                                var placeHolder = response.list[i].main;
                                dd = dd + 1;
                                if (dd < 10) {
                                    dd = '0' + dd;
                                }
                                var forecastDate = mm + '/' + dd + '/' + yyyy;
                                var high = placeHolder.temp_max;
                                var humidity = placeHolder.humidity;
                                var icon = "<img src='https://openweathermap.org/img/w/" + response.list[i].weather[0].icon + ".png'>"
                                $("#forecast").append(
                                    $('<div/>')
                                        .attr("id", "eachForecast")
                                        .addClass("forecastBox col")
                                        .append("<h5>" + forecastDate + "</h5>")
                                        .append("<p>" + icon + "</p>")
                                        .append("<p>" + "Temperature: " + high + "</p>")   //add degress symbol
                                        .append("<p>" + "Humidity: " + humidity + "%" + "</p>")
                                );

                            }
                        }
                    })
                }

                function displaySidebar(subCity) {
                    var cities = [];
                    cities.push(subCity);
                    console.log(cities.length);
                    for (var i = 0; i < cities.length; i++) {
                        console.log(cities);
                        var cityList = $("<div>");
                        var cityButton = $("<button>");
                        var cityName = $("<p>");
                        cityButton.css("width", "100%");
                        cityButton.text(cities[i]);
                        cityList.append(cityButton);
                        cityName.text(cities[i]);
                        $(cityButton).attr("id", cities[i]);
                        $(".sidebar").append(cityList);
                        localStorage.setItem("citiesArray", JSON.stringify(cities[i]));
                    }        

                $(cityButton).on("click", function (event) {

                    // Preventing the button from trying to submit the form
                    event.preventDefault();

                    //initialize the page
                    $(".city").empty();
                    $("#forecast").empty();

                    var subCity = event.target.id;
                    console.log(subCity)
                    var APIKey = "7321de3bce923134cdfb94c3f0188e62";

                    // OpenWeather query for current weather with user imput and api key
                    var queryURL = "https://api.openweathermap.org/data/2.5/weather?q=" + subCity + "&units=imperial&appid=" + APIKey

                    //declare and define date variables
                    var longDate = new Date();
                    console.log(longDate);
                    var dd = longDate.getDate();
                    var mm = longDate.getMonth() + 1;
                    var yyyy = longDate.getFullYear();
                    console.log(mm, dd, yyyy);

                    //call functions for current weather and the five-day forecast
                    //displaySidebar(subCity);
                    getCurrentWeather(queryURL, dd, mm, yyyy);
                    getForecast(subCity, APIKey, dd, mm, yyyy);
                });
            };
            });
        
        </script>
        <!-- BootStrap's jQuery calls -->
        <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
            integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
            crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
            integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
            crossorigin="anonymous"></script>
        <!-- Thanks to GeeksforGeeks for guidance on the date format- https://www.geeksforgeeks.org/how-to-get-current-formatted-date-dd-mm-yyyy-in-javascript/ -->
    </body>

</html>